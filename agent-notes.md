# tgparser refresh-monthly notes

Черновик решений и договорённостей по скрипту `src/refresh-monthly.js`.

## Как пользоваться файлом
- В начале новой сессии прочитай этот файл и следуй инструкциям.
- Каждое существенное решение фиксируй ниже блоком с датой и пунктами “Решение / Причина / Изменения / Что осталось”.
- Не переписывай прошлые записи — только добавляй новые.
- Если меняется договорённость, в новой записи явно отметь, что старая замещается.

## Текущее поведение
- По умолчанию не делаем периодический рефреш: `CHANNEL_REFRESH_DAYS`=-1, обновляем только отсутствующие сущности (если не задан FORCE/ONLY/SKIP).
- Флуд/429: любой ответ с FLOOD/429/Too Many Requests мгновенно падает с логом времени.
- Пауза между TDLib-запросами 3 с (env `TDLIB_REQUEST_DELAY_MS`); скачивание файлов без паузы.
- История: `CHANNEL_HISTORY_FETCH_LIMIT` не клэмпится к 100; собираем все полученные сообщения, логируем батчи, сохраняем сырой счётчик и батч-статистику.
- Речь: асинхронно ждём апдейт с расшифровкой (тайм-аут 20s, затем одно `getMessage`), без циклов поллинга.
- Комментарии: считаем суммарный `reply_count` топ-5 сообщений (по убыванию reply_count). Если <30 — не запрашиваем комментарии и пишем `null`. Если >=30 — собираем до `COMMENT_COMMENT_TOTAL_TARGET` и сохраняем весь массив без усечений.
- RKN: список `src/l.txt` формирует `rknUsernames`; любой чат из списка помечается `is_rkn=1` (включая похожие/апдейты). Добавлены миграции колонок `active_username`, `is_verified`.
- Similar: апдейты `updateNewChat/updateSupergroup/updateSupergroupFullInfo` по похожим каналам сохраняем только если участников >=800 (или это основной канал); записываем реакции-доступ, is_rkn при наличии username.
- Скип каналов: если по username найден `chat_id` и все целевые сущности свежие, при дефолтных настройках канал пропускается без TDLib вызовов.

## Открытые моменты/возможные улучшения
- Хочется ли хранить метаданные для “комментарии не собирали” вместо `null` (чтобы downstream понимал причину)?
- Если нужно агрессивно сохранять similar-каналы без порога 800, порог можно вынести в env или опустить.
- Для тяжёлых каналов, возможно, стоит раздельный лимит на истории/комментарии.

## 2024-XX-XX
- Решение: при ошибках `USERNAME_INVALID`/`USERNAME_NOT_OCCUPIED` переносить канал из `src/l.txt` в `l.fail.txt` (env `CHANNEL_FAIL_LIST_FILE` по умолчанию рядом с `l.txt`).
- Причина: не тратить время на несуществующие юзернеймы и фиксировать их отдельно.
- Изменения: `src/refresh-monthly.js` добавлены чтение/запись списков, фильтр ошибок, лог `Перенёс <name> в l.fail.txt`.
- Что осталось: при необходимости добавить дату вместо `XX-XX` и поддерживать этот раздел при новых правках.

## 2024-XX-XX
- Решение: убрать `has_erid` и раздельную выдачу рекламных постов в LLM — теперь все сообщения идут единым списком, метка рекламы не используется.
- Причина: дублирование и неполное маркирование рекламных постов; проще анализировать единый поток.
- Изменения: `src/llm-handler.js` — удалён `is_ad`, выкинут `ads` из payload, `has_erid` из сводок; engagement считается по всему списку.
- Что осталось: обновить дату блока и при необходимости поправить prompt, если он ожидал поля `ads`/`has_erid`.

## 2024-XX-XX
- Решение: утилита для повторного сбора истории/комментов у каналов с ровно 1 сообщением в БД.
- Причина: добрать полноценную историю там, где сохранён только один пост.
- Изменения: `scripts/refetch-single-message.js` — строит список таких каналов, запускает `refresh-monthly` с `CHANNEL_REFRESH_ONLY=getChatHistory,comments` и `CHANNEL_FORCE_REFRESH=true` на временном списке.
- Что осталось: проставить дату блока; при желании добавить фильтр по отсутствию username (сейчас такие каналы пропускаются).

## 2024-XX-XX
- Решение: отправлять локальные картинки в LLM вместе с JSON.
- Причина: LLM должен анализировать медиаконтент, а не только текст.
- Изменения: `src/llm-handler.js` — инлайним до `LLM_IMAGE_INLINE_LIMIT` файлов (по умолчанию 25, максимум 2 МБ каждый) через `inlineData`; `buildPayload` собирает `images` из `media_local_path` и `callGemini` добавляет их в запрос.
- Что осталось: задать дату блока; при необходимости подправить промпт, если там ожидались только текстовые данные.
